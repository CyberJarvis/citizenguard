'use client';

import { useEffect, useState } from 'react';
import { GeoJSON, useMap } from 'react-leaflet';
import L from 'leaflet';

// Custom icons for different layer types
const createIcon = (iconUrl, size = [24, 24]) => {
  if (typeof window === 'undefined') return null;
  return L.icon({
    iconUrl,
    iconSize: size,
    iconAnchor: [size[0] / 2, size[1]],
    popupAnchor: [0, -size[1]],
  });
};

// Icon configurations
const LAYER_ICONS = {
  ports: {
    major: '/icons/port-major.svg',
    minor: '/icons/port-minor.svg',
    private: '/icons/port-private.svg',
    default: '/icons/port.svg',
  },
  fishingVillages: '/icons/fishing-village.svg',
  coastGuard: {
    'Regional HQ': '/icons/coast-guard-hq.svg',
    'District HQ': '/icons/coast-guard-district.svg',
    'Air Station': '/icons/coast-guard-air.svg',
    Station: '/icons/coast-guard-station.svg',
    default: '/icons/coast-guard.svg',
  },
  marineProtectedAreas: '/icons/marine-protected.svg',
};

// Color schemes for different layers
const LAYER_COLORS = {
  ports: {
    major: '#1e40af',
    minor: '#3b82f6',
    private: '#60a5fa',
    default: '#2563eb',
  },
  fishingVillages: '#f59e0b',
  coastGuard: '#dc2626',
  marineProtectedAreas: {
    'National Park': '#059669',
    Sanctuary: '#10b981',
    default: '#34d399',
  },
  populationDensity: {
    very_high: '#7f1d1d',
    high: '#dc2626',
    medium: '#f97316',
    low: '#facc15',
    very_low: '#84cc16',
  },
};

// Population density thresholds for styling
const getDensityColor = (level) => {
  return LAYER_COLORS.populationDensity[level] || LAYER_COLORS.populationDensity.medium;
};

const getDensityOpacity = (level) => {
  const opacities = {
    very_high: 0.6,
    high: 0.5,
    medium: 0.4,
    low: 0.3,
    very_low: 0.2,
  };
  return opacities[level] || 0.3;
};

// Format number with commas
const formatNumber = (num) => {
  return num ? num.toLocaleString('en-IN') : 'N/A';
};

const VulnerabilityLayer = ({
  showPorts = false,
  showFishingVillages = false,
  showMarineAreas = false,
  showPopulationDensity = false,
  showCoastGuardStations = false,
}) => {
  const map = useMap();
  const [portsData, setPortsData] = useState(null);
  const [fishingVillagesData, setFishingVillagesData] = useState(null);
  const [marineAreasData, setMarineAreasData] = useState(null);
  const [populationData, setPopulationData] = useState(null);
  const [coastGuardData, setCoastGuardData] = useState(null);
  const [loading, setLoading] = useState({});
  const [errors, setErrors] = useState({});

  // Fetch GeoJSON data
  const fetchGeoJSON = async (url, key, setter) => {
    if (loading[key]) return;

    setLoading((prev) => ({ ...prev, [key]: true }));
    setErrors((prev) => ({ ...prev, [key]: null }));

    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Failed to load ${key}`);
      const data = await response.json();
      setter(data);
    } catch (error) {
      console.error(`Error loading ${key}:`, error);
      setErrors((prev) => ({ ...prev, [key]: error.message }));
    } finally {
      setLoading((prev) => ({ ...prev, [key]: false }));
    }
  };

  // Load data when layers are enabled
  useEffect(() => {
    if (showPorts && !portsData) {
      fetchGeoJSON('/geojson/ports.geojson', 'ports', setPortsData);
    }
  }, [showPorts, portsData]);

  useEffect(() => {
    if (showFishingVillages && !fishingVillagesData) {
      fetchGeoJSON('/geojson/fishing_villages.geojson', 'fishingVillages', setFishingVillagesData);
    }
  }, [showFishingVillages, fishingVillagesData]);

  useEffect(() => {
    if (showMarineAreas && !marineAreasData) {
      fetchGeoJSON('/geojson/marine_protected_areas.geojson', 'marineAreas', setMarineAreasData);
    }
  }, [showMarineAreas, marineAreasData]);

  useEffect(() => {
    if (showPopulationDensity && !populationData) {
      fetchGeoJSON('/geojson/population_density.geojson', 'population', setPopulationData);
    }
  }, [showPopulationDensity, populationData]);

  useEffect(() => {
    if (showCoastGuardStations && !coastGuardData) {
      fetchGeoJSON('/geojson/coast_guard_stations.geojson', 'coastGuard', setCoastGuardData);
    }
  }, [showCoastGuardStations, coastGuardData]);

  // Style functions for GeoJSON layers
  const portsStyle = (feature) => ({
    color: LAYER_COLORS.ports[feature.properties.type] || LAYER_COLORS.ports.default,
    weight: 2,
    opacity: 1,
    fillOpacity: 0.7,
  });

  const marineAreasStyle = (feature) => ({
    color: LAYER_COLORS.marineProtectedAreas[feature.properties.type] || LAYER_COLORS.marineProtectedAreas.default,
    weight: 2,
    opacity: 0.8,
    fillOpacity: 0.3,
    dashArray: '5, 5',
  });

  const populationStyle = (feature) => ({
    color: getDensityColor(feature.properties.density_level),
    weight: 1,
    opacity: 0.6,
    fillColor: getDensityColor(feature.properties.density_level),
    fillOpacity: getDensityOpacity(feature.properties.density_level),
  });

  // Point to layer functions for markers
  const portsPointToLayer = (feature, latlng) => {
    const portType = feature.properties.type || 'default';
    return L.circleMarker(latlng, {
      radius: portType === 'major' ? 10 : portType === 'minor' ? 7 : 5,
      fillColor: LAYER_COLORS.ports[portType] || LAYER_COLORS.ports.default,
      color: '#fff',
      weight: 2,
      opacity: 1,
      fillOpacity: 0.8,
    });
  };

  const fishingVillagesPointToLayer = (feature, latlng) => {
    const population = feature.properties.fishermen_population || 0;
    const radius = Math.min(Math.max(population / 5000, 4), 12);
    return L.circleMarker(latlng, {
      radius,
      fillColor: LAYER_COLORS.fishingVillages,
      color: '#fff',
      weight: 2,
      opacity: 1,
      fillOpacity: 0.8,
    });
  };

  const coastGuardPointToLayer = (feature, latlng) => {
    const stationType = feature.properties.type || 'Station';
    const isHQ = stationType.includes('HQ');
    return L.circleMarker(latlng, {
      radius: isHQ ? 10 : 7,
      fillColor: LAYER_COLORS.coastGuard,
      color: '#fff',
      weight: 2,
      opacity: 1,
      fillOpacity: 0.9,
    });
  };

  // Popup content generators
  const portsOnEachFeature = (feature, layer) => {
    const props = feature.properties;
    layer.bindPopup(`
      <div class="vulnerability-popup">
        <h3 class="font-bold text-blue-800">${props.name}</h3>
        <div class="text-sm mt-1">
          <p><strong>Type:</strong> ${props.type}</p>
          <p><strong>State:</strong> ${props.state}</p>
          <p><strong>Capacity:</strong> ${props.capacity}</p>
          ${props.description ? `<p class="mt-1 text-gray-600">${props.description}</p>` : ''}
        </div>
      </div>
    `);
    layer.bindTooltip(props.name, { direction: 'top', offset: [0, -10] });
  };

  const fishingVillagesOnEachFeature = (feature, layer) => {
    const props = feature.properties;
    layer.bindPopup(`
      <div class="vulnerability-popup">
        <h3 class="font-bold text-amber-700">${props.name}</h3>
        <div class="text-sm mt-1">
          <p><strong>State:</strong> ${props.state}</p>
          <p><strong>District:</strong> ${props.district}</p>
          <p><strong>Fishermen Population:</strong> ${formatNumber(props.fishermen_population)}</p>
          <p><strong>Boats:</strong> ${formatNumber(props.boat_count)}</p>
          <p><strong>Primary Catch:</strong> ${props.primary_catch}</p>
        </div>
      </div>
    `);
    layer.bindTooltip(`${props.name} (${formatNumber(props.fishermen_population)} fishermen)`, { direction: 'top', offset: [0, -10] });
  };

  const marineAreasOnEachFeature = (feature, layer) => {
    const props = feature.properties;
    layer.bindPopup(`
      <div class="vulnerability-popup">
        <h3 class="font-bold text-green-700">${props.name}</h3>
        <div class="text-sm mt-1">
          <p><strong>Type:</strong> ${props.type}</p>
          <p><strong>State:</strong> ${props.state}</p>
          <p><strong>Area:</strong> ${props.area_sq_km} sq km</p>
          <p><strong>Established:</strong> ${props.established}</p>
          ${props.description ? `<p class="mt-1 text-gray-600">${props.description}</p>` : ''}
          ${props.protected_species ? `<p class="mt-1"><strong>Protected Species:</strong> ${props.protected_species.join(', ')}</p>` : ''}
        </div>
      </div>
    `);
    layer.bindTooltip(props.name, { direction: 'center' });
  };

  const populationOnEachFeature = (feature, layer) => {
    const props = feature.properties;
    const densityLabels = {
      very_high: 'Very High (>5000/km²)',
      high: 'High (1000-5000/km²)',
      medium: 'Medium (500-1000/km²)',
      low: 'Low (100-500/km²)',
      very_low: 'Very Low (<100/km²)',
    };
    layer.bindPopup(`
      <div class="vulnerability-popup">
        <h3 class="font-bold text-orange-700">${props.name}</h3>
        <div class="text-sm mt-1">
          <p><strong>State:</strong> ${props.state}</p>
          <p><strong>Population:</strong> ${formatNumber(props.population)}</p>
          <p><strong>Density:</strong> ${formatNumber(props.density)}/km²</p>
          <p><strong>Level:</strong> ${densityLabels[props.density_level] || props.density_level}</p>
          <p><strong>Coastal Length:</strong> ${props.coastal_km} km</p>
        </div>
      </div>
    `);
    layer.bindTooltip(`${props.name}: ${formatNumber(props.density)}/km²`, { direction: 'center' });
  };

  const coastGuardOnEachFeature = (feature, layer) => {
    const props = feature.properties;
    layer.bindPopup(`
      <div class="vulnerability-popup">
        <h3 class="font-bold text-red-700">${props.name}</h3>
        <div class="text-sm mt-1">
          <p><strong>Type:</strong> ${props.type}</p>
          <p><strong>Region:</strong> ${props.region}</p>
          <p><strong>State:</strong> ${props.state}</p>
          <p><strong>Contact:</strong> <a href="tel:${props.contact}" class="text-blue-600">${props.contact}</a></p>
          ${props.capabilities ? `<p class="mt-1"><strong>Capabilities:</strong> ${props.capabilities.join(', ')}</p>` : ''}
        </div>
      </div>
    `);
    layer.bindTooltip(props.name, { direction: 'top', offset: [0, -10] });
  };

  return (
    <>
      {/* Population Density Layer - render first (bottom layer) */}
      {showPopulationDensity && populationData && (
        <GeoJSON
          key="population-density"
          data={populationData}
          style={populationStyle}
          onEachFeature={populationOnEachFeature}
        />
      )}

      {/* Marine Protected Areas Layer */}
      {showMarineAreas && marineAreasData && (
        <GeoJSON
          key="marine-areas"
          data={marineAreasData}
          style={marineAreasStyle}
          onEachFeature={marineAreasOnEachFeature}
        />
      )}

      {/* Ports Layer */}
      {showPorts && portsData && (
        <GeoJSON
          key="ports"
          data={portsData}
          pointToLayer={portsPointToLayer}
          onEachFeature={portsOnEachFeature}
        />
      )}

      {/* Fishing Villages Layer */}
      {showFishingVillages && fishingVillagesData && (
        <GeoJSON
          key="fishing-villages"
          data={fishingVillagesData}
          pointToLayer={fishingVillagesPointToLayer}
          onEachFeature={fishingVillagesOnEachFeature}
        />
      )}

      {/* Coast Guard Stations Layer */}
      {showCoastGuardStations && coastGuardData && (
        <GeoJSON
          key="coast-guard"
          data={coastGuardData}
          pointToLayer={coastGuardPointToLayer}
          onEachFeature={coastGuardOnEachFeature}
        />
      )}
    </>
  );
};

export default VulnerabilityLayer;
